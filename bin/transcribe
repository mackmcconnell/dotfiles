#!/bin/bash
# transcribe - Voice memo to Apple Note pipeline
#
# What it does:
#   Records a voice memo on iPhone, then this command transcribes it into text
#   and creates a new Apple Note with the transcript. Useful for brain dumps,
#   journaling, or capturing ideas while walking around.
#
# How it works:
#   1. Finds the latest .m4a/.qta file in the Voice Memos iCloud sync directory
#      (skips files already marked as transcribed)
#   2. Runs Whisper to convert speech to text (locally or via OpenAI API)
#   3. Creates a new Apple Note titled "Brain Dump - <date>" with the transcript
#   4. Renames the original audio file with "(transcribed)" appended so you
#      know it's been processed and can delete it
#
# Usage:
#   transcribe              Transcribe locally (private, slower)
#   transcribe --cloud      Transcribe via OpenAI API (fast, sends audio to OpenAI)
#   transcribe <file>       Transcribe a specific audio file
#   transcribe <name>       Transcribe by Voice Memos app name (e.g. "New Recording 50")
#
# Environment:
#   WHISPER_MODEL           Whisper model size for local mode (default: "small")
#                           Options: tiny, base, small, medium, large
#   OPENAI_API_KEY          Required for --cloud mode
#
# Dependencies:
#   Local mode: openai-whisper (pip install openai-whisper)
#   Cloud mode: curl + OPENAI_API_KEY
#   Both: Voice Memos iCloud sync enabled on iPhone

set -euo pipefail

MODEL="${WHISPER_MODEL:-small}"
VOICE_MEMOS_DIR="$HOME/Library/Group Containers/group.com.apple.VoiceMemos.shared/Recordings"
USE_CLOUD=false

# --- Parse flags ---
ARGS=()
for arg in "$@"; do
    if [ "$arg" = "--cloud" ]; then
        USE_CLOUD=true
    else
        ARGS+=("$arg")
    fi
done
set -- "${ARGS[@]+"${ARGS[@]}"}"

# --- Find audio file ---
if [ $# -gt 0 ] && [ -f "$1" ]; then
    AUDIO="$1"
elif [ $# -gt 0 ]; then
    # Look up by Voice Memos app name
    NAME="$*"
    DB="$VOICE_MEMOS_DIR/CloudRecordings.db"
    if [ ! -f "$DB" ]; then
        echo "Voice Memos database not found."
        exit 1
    fi
    FILENAME=$(sqlite3 "$DB" "SELECT ZPATH FROM ZCLOUDRECORDING WHERE ZENCRYPTEDTITLE = '$(echo "$NAME" | sed "s/'/''/g")' AND ZPATH IS NOT NULL AND ZPATH != '' LIMIT 1;")
    if [ -z "$FILENAME" ]; then
        echo "No voice memo found with name: $NAME"
        exit 1
    fi
    AUDIO="$VOICE_MEMOS_DIR/$FILENAME"
    if [ ! -f "$AUDIO" ]; then
        echo "File not synced yet: $FILENAME"
        exit 1
    fi
else
    if [ ! -d "$VOICE_MEMOS_DIR" ]; then
        echo "Voice Memos not syncing to this Mac."
        echo "Enable in: iPhone Settings > Apple ID > iCloud > Voice Memos"
        echo ""
        echo "Or pass a file directly:"
        echo "  transcribe /path/to/audio.m4a"
        exit 1
    fi

    AUDIO=$(find "$VOICE_MEMOS_DIR" \( -name "*.m4a" -o -name "*.qta" \) -not -name "*(transcribed)*" -type f | sort -r | head -1)

    if [ -z "${AUDIO:-}" ]; then
        echo "No untranscribed voice memos found."
        exit 1
    fi
fi

echo "Transcribing: $(basename "$AUDIO")"

# --- Transcribe ---
TMP=$(mktemp -d)
trap 'rm -rf "$TMP"' EXIT

if [ "$USE_CLOUD" = true ]; then
    # --- Cloud: OpenAI Whisper API ---
    if [ -z "${OPENAI_API_KEY:-}" ]; then
        echo "OPENAI_API_KEY not set. Required for --cloud mode."
        exit 1
    fi

    echo "Using OpenAI Whisper API..."

    # Convert .qta to .m4a if needed (API doesn't support .qta)
    UPLOAD_FILE="$AUDIO"
    if [[ "$AUDIO" == *.qta ]]; then
        UPLOAD_FILE="$TMP/$(basename "${AUDIO%.*}").m4a"
        ffmpeg -i "$AUDIO" -codec copy "$UPLOAD_FILE" -y -loglevel error
    fi

    RESPONSE=$(curl -s -X POST "https://api.openai.com/v1/audio/transcriptions" \
        -H "Authorization: Bearer $OPENAI_API_KEY" \
        -F "file=@$UPLOAD_FILE" \
        -F "model=whisper-1" \
        -F "language=en" \
        -F "response_format=text" \
        -F "prompt=Hello, welcome. This is a recording with proper punctuation, including commas, periods, and question marks.")

    if [ -z "$RESPONSE" ] || echo "$RESPONSE" | grep -q '"error"'; then
        echo "Transcription failed: $RESPONSE"
        exit 1
    fi

    TRANSCRIPT="$RESPONSE"
else
    # --- Local: openai-whisper ---
    if ! command -v whisper &>/dev/null; then
        echo ""
        echo "whisper not installed. Run:"
        echo "  pip install openai-whisper"
        echo ""
        echo "Or use --cloud for the OpenAI API instead."
        exit 1
    fi

    echo "Using local Whisper ($MODEL model)..."
    whisper "$AUDIO" --model "$MODEL" --language en --output_format txt --output_dir "$TMP" 2>/dev/null

    TRANSCRIPT_FILE="$TMP/$(basename "${AUDIO%.*}").txt"

    if [ ! -f "$TRANSCRIPT_FILE" ] || [ ! -s "$TRANSCRIPT_FILE" ]; then
        echo "Transcription failed or came back empty."
        exit 1
    fi

    TRANSCRIPT=$(cat "$TRANSCRIPT_FILE")
fi

# --- Create Apple Note ---
NOTE_TITLE="Brain Dump - $(date '+%B %d, %Y %-I:%M %p')"
BODY_FILE=$(mktemp)
printf '%s' "$TRANSCRIPT" > "$BODY_FILE"

osascript - "$NOTE_TITLE" "$BODY_FILE" <<'APPLESCRIPT'
on run argv
    set noteTitle to item 1 of argv
    set bodyPath to item 2 of argv
    set noteBody to do shell script "cat " & quoted form of bodyPath
    tell application "Notes"
        make new note at folder "Transcriptions" with properties {name:noteTitle, body:noteBody}
    end tell
end run
APPLESCRIPT

rm -f "$BODY_FILE"

# --- Copy to clipboard ---
printf '%s' "$TRANSCRIPT" | pbcopy

# --- Mark audio as transcribed ---
DIR=$(dirname "$AUDIO")
EXT="${AUDIO##*.}"
BASE=$(basename "$AUDIO" ".$EXT")
mv "$AUDIO" "$DIR/${BASE} (transcribed).$EXT"

# Update title in Voice Memos app database
DB="$VOICE_MEMOS_DIR/CloudRecordings.db"
FILENAME=$(basename "$AUDIO")
if [ -f "$DB" ]; then
    CURRENT_TITLE=$(sqlite3 "$DB" "SELECT ZENCRYPTEDTITLE FROM ZCLOUDRECORDING WHERE ZPATH = '$FILENAME';")
    if [ -n "$CURRENT_TITLE" ]; then
        sqlite3 "$DB" "UPDATE ZCLOUDRECORDING SET ZENCRYPTEDTITLE = '${CURRENT_TITLE} (transcribed)' WHERE ZPATH = '$FILENAME';"
    else
        sqlite3 "$DB" "UPDATE ZCLOUDRECORDING SET ZENCRYPTEDTITLE = '(transcribed)' WHERE ZPATH = '$FILENAME';"
    fi
fi

echo ""
echo "Created Apple Note: $NOTE_TITLE"
echo "Renamed: $(basename "$AUDIO") -> ${BASE} (transcribed).$EXT"
echo "Transcript copied to clipboard."
echo "---"
echo "$TRANSCRIPT"
